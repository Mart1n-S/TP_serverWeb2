worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # server {
    #     listen 80;
    #     listen 8080;
    #     server_name localhost;
    #     return 301 https://$host$request_uri;
    # }
    
    server {
        # listen 443 ssl;
        listen 8080 ssl;
        server_name localhost;

        # modsecurity on;
        # modsecurity_rules_file /etc/nginx/modsec/modsecurity.conf;

        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;

        # Autoriser uniquement les requêtes POST vers /generate_token.php
        location = /generate_token.php {
            limit_except POST {
                deny all;
            }
            proxy_pass http://donsecure-apache:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Rediriger vers / si JWT valide (accès à login.html bloqué si déjà connecté)
        location = /jwt/login.html {
            access_by_lua_block {
                local jwt = require "resty.jwt"

                local function read_secret_key(path)
                    local f = io.open(path, "r")
                    if not f then return nil end
                    local key = f:read("*a")
                    f:close()
                    return key and key:gsub("%s+", "") or nil
                end

                local key = read_secret_key("/etc/nginx/jwt-secret.key")

                local cookie = ngx.var.http_cookie
                local token = cookie and string.match(cookie, "auth_token=([^;]+)")

                if key and token then
                    local jwt_obj = jwt:verify(key, token)
                    if jwt_obj.verified then
                        return ngx.redirect("/")
                    end
                end
                -- sinon continuer et afficher login.html
            }

            root /usr/local/openresty/nginx/html;
        }

        # Accès libre aux fichiers statiques (CSS, JS, etc.)
        location /jwt/ {
            root /usr/local/openresty/nginx/html;
        }

        # Vérification JWT pour toutes les autres routes
        location / {
            access_by_lua_file /usr/local/openresty/nginx/html/jwt/jwt_verifier.lua;
            proxy_pass http://donsecure-apache:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Redirections en cas d'erreur
        error_page 401 = /jwt/login.html;
        error_page 403 = /jwt/login.html;
    }
}